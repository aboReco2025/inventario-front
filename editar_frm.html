<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Inventario Recovery</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>

<body>
    <h1 class="titulo">Editar Inventario Abogados Recovery</h1>

    <a class="btn btn-success" style="float:right" href="index.html">Inventario</a><br>

    <form class="form-select" size="3" aria-label="Size 3 select example" id="formulario">
        <div class="row justify-content-md-center">
            <div class="form-group col-md-2">
                <label for="id_implemento">ID del implemento</label>
                <div>
                    <input onchange="activarID()" class="form-control" type="text" name="id_implemento"
                        id="id_implemento" readonly>
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="categoria">Categoria</label>
                <div>
                    <select onload="activarCategoria()" onchange="nombre()" name="categoria" class="form-select"
                        aria-label="Default select example" id="categoria">
                        <option value="Equipos de Computo">Equipos de Computo</option>
                        <option value="Muebles">Muebles</option>
                    </select>
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="implemento">Tipo de implemento</label>
                <div>
                    <select name="implemento_name" class="form-select" aria-label="Default select example"
                        id="implemento_name">
                    </select>
                </div>

            </div>

            <div class="form-group col-md-2">
                <label for="departamento">Departamento</label>
                <div>
                    <select name="departamento" class="form-select" aria-label="Default select example"
                        id="departamento">
                    </select>
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="condicion">Condición</label>
                <div>
                    <select onchange="activarCondicion()" class="form-select" aria-label="Default select example"
                        id="condicion">
                        <option value="Nuevo">Nuevo</option>
                        <option value="Bueno">Bueno</option>
                        <option value="Regular">Regular</option>
                        <option value="Malo">Malo</option>
                    </select>
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="Sede">Sede</label>
                <div>
                    <select onchange="activarSede()" class="form-select" arial-label="Default select example" id="sede">
                        <option value="" disabled selected>Seleccione a quien pertenece</option>
                        <option value="Bello">Bello</option>
                        <option value="Cali">Cali</option>
                    </select>
                </div>
            </div>
        </div>

        <br>

        <div class="row justify-content-md-center">
            <div class="form-group col-md-2">
                <label for="Descripción">Descripción</label>
                <div>
                    <input onchange="activarDescripcion()" class="form-control" name="descripcion"
                        placeholder="Añade la descripción" id="descripcion">
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="Pertenencia">Propiedad</label>
                <div>
                    <select onchange="activarPertenencia()" class="form-select" aria-label="Default select example"
                        id="pertenencia">
                        <option value="Propio">Propio</option>
                        <option value="Alquiler">Alquiler</option>
                    </select>
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="Propietario">Propietario</label>
                <div>
                    <select class="form-select" aria-label="Default select example" id="propietario">
                        <option value="1">Abogados Recovery</option>
                        <option value="2">Milenio Pc</option>
                        <option value="3">Flycomm</option>
                    </select>
                </div>
            </div>
            <div class="form-group col-md-2">
                <label for="valor">Valor</label>
                <div>
                    <input onchange="activarValor()" class="form-control" type="number" name="valor" id="valor">
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="fecha">Fecha</label>
                <div>
                    <input onchange="activarFecha()" class="form-control" type="date" name="fecha" id="fecha">
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="estado">Estado</label>
                <div>
                    <select onchange="activarEstado()" name="estado" class="form-select" name="estado"
                        aria-label="Default select example" id="estado">
                        <option value="Activo">Activo</option>
                        <option value="Inactivo">Inactivo</option>
                    </select>
                </div>
            </div>
        </div>

        <br>

        <label for="botones">
            <div>
                <button type='update' class="btn btn-primary" name="submit" id="btnUpdate">Actualizar</button>
            </div>
        </label>

    </form>
    <script>
        (async () => {
            const valor = document.querySelector('#valor');
            const fecha = document.querySelector('#fecha');
            const estado = document.querySelector('#estado');
            const pertenencia = document.querySelector('#pertenencia');
            const propietario = document.querySelector('#propietario');
            const condicion = document.querySelector('#condicion');
            const departamento = document.querySelector('#departamento');
            const nombre_imp = document.querySelector('#implemento_name');
            const categoria = document.querySelector('#categoria');
            const id_implemento = document.querySelector('#id_implemento');
            const sede = document.querySelector('#sede');
            const descripcion = document.querySelector('#descripcion');

            // Espera a que recorrerDepartamentos() se complete
            await recorrerDepartamentos();

            traerInformacion().then(async (informacion) => {
                console.log(informacion);

                // Verifica si el objeto informacion está vacío
                if (Object.keys(informacion).length === 0) {
                    console.error("Error: La información del implemento está vacía.");
                    alert("Error al cargar la información del implemento. Por favor, inténtelo de nuevo.");
                    return; // Sale de la función si la información está vacía
                }

                valor.value = informacion.valor;

                const fechaObj = new Date(informacion.fecha);
                const fechaFormateadaInput = fechaObj.toISOString().split('T')[0];
                fecha.value = fechaFormateadaInput;
                estado.value = informacion.estado;
                pertenencia.value = informacion.pertenencia;
                propietario.value = informacion.propietario;
                condicion.value = informacion.condicion;
                departamento.value = informacion.departamento;
                categoria.value = informacion.categoria;
                await activarCategoria();
                await nombre(informacion.nombre);
                nombre_imp.value = informacion.nombre;
                id_implemento.value = informacion.id_implemento;
                descripcion.value = informacion.descripcion;
                sede.value = informacion.sede;
                console.log("Información de departamentos cargada correctamente.");
                console.log(informacion.sede);
                console.log(informacion.departamento);
                console.log(informacion.propietario);
            }).catch(error => {
                console.error("Error al cargar la información de departamentos:", error);
            });

            // Obtener la fecha actual en formato YYYY-MM-DD
            const hoy = new Date().toISOString().split("T")[0];

            // Asignar la fecha máxima al input
            document.getElementById("fecha").setAttribute("max", hoy);
        })();
        // Captura la información del nombre del implemento en el formulario
        function activarNombre() {
            const implemento = document.querySelector('#implemento_name');
            return implemento.value;
        }
        // Captura la información del nombre de la categoria en el formulario
        function activarCategoria() {
            const categoria = document.querySelector('#categoria');
            return categoria.value;
        }
        // Captura la información del nombre del departamento en el formulario
        function activarDepartamento() {
            const inventario = document.querySelector('#departamento');
            return inventario.value;
        }
        // Captura la información del nombre de la condición en el formulario
        function activarCondicion() {
            const inventario = document.querySelector('#condicion');
            return inventario.value;
        }
        // Captura la información del nombre del propietario en el formulario
        function activarPertenencia() {
            const inventario = document.querySelector('#pertenencia');
            return inventario.value;
        }

        function activarPropietario() {
            const inventario = document.querySelector('#propietario');
            return inventario.value;
        }


        // Captura la información del nombre del valor en el formulario
        function activarValor() {
            const inventario = document.querySelector('#valor');
            if (Number(inventario.value) < 10000) {
                alert("El valor debe ser mayor a 10000")
                inventario.reset();
                return;
            }
            else {
                if (Number(inventario.value) > 100000000) {
                    alert("El valor debe ser menor a 100.000.000")
                    inventario.reset();
                    return;
                }
            }
            return inventario.value;
        }
        // Captura la información del nombre de la fecha en el formulario
        function activarFecha() {
            const inventario = document.querySelector('#fecha');
            return inventario.value;
        }

        function activarEstado() {
            const estado = document.querySelector('#estado');
            return estado.value;
        }

        function activarSede() {
            const inventario = document.querySelector('#sede');
            console.log(inventario.value);
            return inventario.value;
        }

        function activarDescripcion() {
            const inventario = document.querySelector('#descripcion');
            console.log(typeof inventario.value);

            return inventario.value;
        }

        //Inserta la información en la tabla del front
        const tabla = document.querySelector('#tabla #tabla-body');

        // Captura la información del formulario y la agrega a la tabla
        const form = document.querySelector('#formulario');

        form.addEventListener('submit', async function (event) {
            event.preventDefault();
            const nombre = activarNombre();
            const categoria = activarCategoria();
            const departamento = activarDepartamento();
            const condicion = activarCondicion();
            const pertenencia = activarPertenencia();
            const propietario = activarPropietario();
            const valor = activarValor();
            const fecha = activarFecha();
            const estado = activarEstado();
            const descripcion = activarDescripcion();
            const sede = activarSede();

            const datos = {
                nombre,
                categoria,
                departamento,
                condicion,
                pertenencia,
                propietario,
                valor,
                fecha,
                estado,
                sede,
                descripcion
            };
            actualizarImplemento(datos);
            console.log("datos enviados a bk" + datos);
            window.location.href = `index.html`;
        })


        // Limpia el formulario después de agregar la fila o darle click en el botónde limpiar
        function limpiarFormulario() {
            document.querySelector('#formulario').reset();
        }

        async function nombre(selectedValue = null) {
            const name = document.querySelector("#implemento_name");
            const categoria = document.querySelector("#categoria").value;
            const url = `http://localhost:3000/api/inventario/cat_implemento/${encodeURIComponent(categoria)}`;

            if (!categoria) {
                name.innerHTML = "";
                return;
            }
            // Limpia las opciones previas
            name.innerHTML = "";
            name.innerHTML = '<option value="" disabled selected>Seleccione el implemento</option>';
            try {
                const res = await fetch(url, { method: 'GET' });
                const lista_cat = await res.json();
                for (let implemento of lista_cat) {
                    let nuevaOpcion = document.createElement("option");
                    nuevaOpcion.value = implemento.nom_implemento;
                    nuevaOpcion.text = implemento.nom_implemento;
                    name.add(nuevaOpcion);
                }
                // Si se pasa un valor seleccionado, asígnalo
                if (selectedValue) {
                    name.value = selectedValue;
                }
            } catch (error) {
                console.error("¡Error!", error);
            }
        }


        function recorrerDepartamentos() {
            return new Promise((resolve, reject) => {
                const select = document.querySelector("#departamento");
                const url = 'http://localhost:3000/api/inventario/departamento';
                fetch(url, {
                    method: 'GET',
                })
                    .then(res => res.json())
                    .then(lista_de_departamentos => {
                        for (let departamento of lista_de_departamentos) {
                            let nuevaOpcion = document.createElement("option");
                            nuevaOpcion.value = departamento.id;
                            nuevaOpcion.text = departamento.nombre;
                            select.add(nuevaOpcion);
                        }
                        resolve();
                    })
                    .catch(function (error) {
                        console.error("¡Error!", error);
                        (reject.error);
                    });
            });
        }

        function recorrerImplementos() {
            const select = document.querySelector("#categoria");
            const url = 'http://localhost:3000/api/inventario/cat_implemento';
            fetch(url, {
                method: 'GET',
            })
                .then(res => res.json())
                .then(lista_cat => {
                    for (let implemento of lista_cat) {
                        let nuevaOpcion = document.createElement("option");
                        nuevaOpcion.value = implemento.id;
                        nuevaOpcion.text = implemento.nombre;
                        select.add(nuevaOpcion);
                    }
                })
                .catch(function (error) {
                    console.error("¡Error!", error);
                })
        }

        function traerInformacion() {
            return new Promise((resolve, reject) => {
                const id = sessionStorage.getItem('id');
                const url = 'http://localhost:3000/api/inventario/implemento/' + id;
                fetch(url, {
                    method: 'GET',
                })
                    .then(res => {
                        if (!res.ok) {
                            // Si el estado no es OK, rechaza la promesa con un error
                            return reject(new Error(`HTTP error! Status: ${res.status}`));
                        }
                        // Verifica si la respuesta está vacía
                        if (res.status === 204) {
                            return reject(new Error("No Content: La respuesta está vacía"));
                        }
                        return res.json();
                    })
                    .then(implemento => {
                        resolve(implemento);
                    })
                    .catch(function (error) {
                        console.error("¡Error!", error);
                        reject(error);
                    });
            })
        }

        function actualizarImplemento(datos) {
            const id = sessionStorage.getItem('id');
            fetch(`http://localhost:3000/api/inventario/implemento/` + id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
                .then(res => res.json())
                .then(data => {
                    console.log('✔ Actualizado Correctamente:', data);
                    alert(data.mensaje);

                })
                .catch(error => {
                    console.error('❌ Error al enviar al backend:', error);
                    alert('Error al guardar en la base de datos');
                });
            alert('✅ Actualizado Correctamente');
        }
    </script>
</body>

</html>