<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Inventario Recovery</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>

<body onload="recorrerDepartamentos()">
    <h1 class="titulo">Añadir Inventario Abogados Recovery</h1>

    <a class="btn btn-success" style="float:right" href="index.html">Inventario</a><br>

    <form class="form-select" size="3" aria-label="Size 3 select example" id="formulario">
        <div class="row justify-content-md-center">
            <div class="form-group col-md-2">
                <label for="categoria">Categoria </label>
                <div>
                    <select onchange="activarCategoria(); nombre()" class="form-select"
                        aria-label="Default select example" id="categoria">
                        <option value="" disabled selected>Seleccione la categoría</option>
                        <option value="Equipos de computo">Equipos de computo</option>
                        <option value="Muebles">Muebles</option>
                    </select>
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="implemento_name">Tipo de implemento </label>
                <div>
                    <select name="implemento_name" class="form-select" aria-label="Default select example"
                        id="implemento_name">
                        <option value="" disabled selected>Seleccione el implemento</option>
                    </select>
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="departamento">Departamento</label>
                <div>
                    <select name="departamento" class="form-select" aria-label="Default select example"
                        id="departamento">
                        <option value="" disabled selected>Seleccione el departamento</option>
                    </select>
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="estado">Condición</label>
                <div>
                    <select onchange="activarCondicion()" class="form-select" aria-label="Default select example"
                        id="condicion">
                        <option value="" disabled selected>Seleccione la Condición</option>
                        <option value="Nuevo">Nuevo</option>
                        <option value="Bueno">Bueno</option>
                        <option value="Regular">Regular</option>
                        <option value="Malo">Malo</option>
                    </select>
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="Sede">Sede</label>
                <div>
                    <select onchange="activarSede()" class="form-select" arial-label="Default select example" id="sede">
                        <option value="" disabled selected>Seleccione a quien pertenece</option>
                        <option value="Bello">Bello</option>
                        <option value="Cali">Cali</option>
                    </select>
                </div>
            </div>
        </div>

        <br>

        <div class="row justify-content-md-center">
            <div class="form-group col-md-2">
                <label for="Descripción">Descripción</label>
                <div>
                    <input onchange="activarDescripcion()" class="form-control" name="descripcion" placeholder="Añade la descripción" id="descripcion">
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="Pertenencia">Propiedad </label>
                <div>
                    <select onchange="activarPertenencia()" class="form-select" aria-label="Default select example"
                        id="pertenencia">
                        <option value="" disabled selected>Seleccione a quien pertenece</option>
                        <option value="Propio">Propio</option>
                        <option value="Alquiler">Alquiler</option>
                    </select>
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="Propietario">Propietario</label>
                <div>
                    <select class="form-select" aria-label="Default select example" id="propietario">
                        <option value="" disabled selected>Seleccione el propietario</option>
                        <option value="1">Abogados Recovery</option>
                        <option value="2">Milenio Pc</option>
                        <option value="3">Flycomm</option>
                    </select>
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="valor">Valor</label>
                <div>
                    <input onchange="activarValor()" class="form-control" type="number" name="valor"
                        placeholder="Ingrese el valor" id="valor">
                </div>
            </div>

            <div class="form-group col-md-2">
                <label for="fecha">Fecha</label>
                <div>
                    <input onchange="activarFecha()" class="form-control" type="date" name="fecha"
                        placeholder="Ingrese la Fecha" id="fecha">
                </div>

            </div>


        </div>
        <div class="row justify-content-md-center">
            <div class="form-group col-md-2 just">
                <label for="botones"></label>
                <div>
                    <button type='submit' class="btn btn-primary" name="submit" id="btnRegistrar">Registrar</button>
                    <button onclick="limpiarFormulario()" type='button' class="btn btn-danger"
                        id="btnLimpiar">Limpiar</button>
                </div>
            </div>
        </div>
    </form>
</body>
<script>
    // Obtener la fecha actual en formato YYYY-MM-DD
    const hoy = new Date().toISOString().split("T")[0];

    // Asignar la fecha máxima al input
    document.getElementById("fecha").setAttribute("max", hoy);
    
    // Captura la información del nombre del implemento en el formulario
    function activarNombre() {
        const implemento = document.querySelector('#implemento_name');
        if (implemento.value == "") {
            alert("Por favor, seleccione un implemento");
            return null;
        }
        return implemento.value;
    }
    // Captura la información del nombre de la categoria en el formulario
    function activarCategoria() {
        const categoria = document.querySelector('#categoria');
        if (categoria.value == "") {
            alert("Por favor, seleccione una catego");
            return null;
        }
        return categoria.value;
    }
    // Captura la información del nombre del departamento en el formulario
    function activarDepartamento() {
        const inventario = document.querySelector('#departamento');
        if (inventario.value == "") {
            alert("Por favor, seleccione un departamento");
            return null;
        }
        return inventario.value;
    }
    // Captura la información del nombre de la condición en el formulario
    function activarCondicion() {
        const inventario = document.querySelector('#condicion');
        if (inventario.value == "") {
            alert("Por favor, seleccione el estado del implemento");
            return null;
        }
        return inventario.value;
    }
    // Captura la información del nombre del propietario en el formulario
    function activarPertenencia() {
        const inventario = document.querySelector('#pertenencia');
        if (inventario.value == "") {
            alert("Por favor, seleccione la pertenencia del implemento");
            return null;
        }
        return inventario.value;
    }

    function activarPropietario() {
        const inventario = document.querySelector('#propietario');
        if (inventario.value == "") {
            alert("Por favor, seleccione el propietario del implemento");
            return null;
        }
        return inventario.value;
    }

    function activarValor() {
        const inventario = document.querySelector('#valor');
        if (Number(inventario.value) < 10000) {
            alert("El valor debe ser mayor a 10000")
            inventario.reset();
            return;
        }
        else {
            if (Number(inventario.value) > 100000000) {
                alert("El valor debe ser menor a 100.000.000")
                inventario.reset();
                return;
            }
        }
        return inventario.value;
    }

    // Captura la información del nombre de la fecha en el formulario
    function activarFecha() {
        const inventario = document.querySelector('#fecha');
        if (fecha.value == "") {
            alert("Por favor, seleccione una fecha");
            return null;
        }
        console.log(inventario.value);
        return inventario.value;
    }

    function activarSede(){
        const inventario = document.querySelector('#sede');
        console.log(inventario.value);
        return inventario.value;
    }

    function activarDescripcion(){
        const inventario = document.querySelector('#descripcion');
        console.log(typeof inventario.value);
        
        return inventario.value;
    }


    //Inserta la información en la tabla del front
    const tabla = document.querySelector('#tabla #tabla-body');

    // Captura la información del formulario y la agrega a la tabla
    const form = document.querySelector('#formulario');

    limpiarFormulario();

    form.addEventListener('submit', async function (event) {
        event.preventDefault();
        const nombre = activarNombre();
        const categoria = activarCategoria();
        const departamento = activarDepartamento();
        const condicion = activarCondicion();
        const pertenencia = activarPertenencia();
        const propietario = activarPropietario();
        const valor = activarValor();
        const fecha = activarFecha();
        const sede = activarSede();
        const descripcion = activarDescripcion();

        if (!nombre || !categoria || !departamento || !condicion || !pertenencia || !propietario || !valor || !fecha || !sede || !descripcion) {
            return;
        }

        const datos = {
            nombre,
            categoria,
            departamento,
            condicion,
            pertenencia,
            propietario,
            valor,
            fecha,
            sede,
            descripcion
        };
        console.log(datos);
        enviarAlBackend(datos);
        alert('✅ Datos guardados correctamente');
        window.location.href = `index.html`;

    })

    


    // Limpia el formulario después de agregar la fila o darle click en el botónde limpiar
    function limpiarFormulario() {
        document.querySelector('#formulario').reset();
    }

    function enviarAlBackend(datos) {
        fetch('http://localhost:3000/api/inventario/implemento', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(datos)
        })
            .then(res => res.json())
            .then(data => {
                console.log('✔ Enviado al backend:', data);
            })
            .catch(error => {
                console.error('❌ Error al enviar al backend:', error);
                alert('Error al guardar en la base de datos');
            });
    }



    function nombre() {
        const name = document.querySelector("#implemento_name");
        const categoria = document.querySelector("#categoria").value;
        const url = `http://localhost:3000/api/inventario/cat_implemento/${encodeURIComponent(categoria)}`;
        name.innerHTML = '<option value="" disabled selected>Seleccione el implemento</option>';
        fetch(url, {
            method: 'GET',
        })
            .then(res => res.json())
            .then(lista_cat => {
                for (let implemento of lista_cat) {
                    let nuevaOpcion = document.createElement("option");
                    nuevaOpcion.value = implemento.nom_implemento;
                    nuevaOpcion.text = implemento.nom_implemento;
                    name.add(nuevaOpcion);
                }
            })
            .catch(function (error) {
                console.error("¡Error!", error);
            });
    }


    function recorrerDepartamentos() {
        const select = document.querySelector("#departamento");
        const url = 'http://localhost:3000/api/inventario/departamento';
        fetch(url, {
            method: 'GET',
        })
            .then(res => res.json())
            .then(lista_de_departamentos => {
                for (let departamento of lista_de_departamentos) {
                    let nuevaOpcion = document.createElement("option");
                    nuevaOpcion.value = departamento.id;
                    nuevaOpcion.text = departamento.nombre;
                    select.add(nuevaOpcion);
                }
            })
            .catch(function (error) {
                console.error("¡Error!", error);
            });
    }

    function recorrerImplementos() {
        const select = document.querySelector("#categoria");
        const url = 'http://localhost:3000/api/inventario/cat_implemento';
        fetch(url, {
            method: 'GET',
        })
            .then(res => res.json())
            .then(lista_cat => {
                for (let implemento of lista_cat) {
                    let nuevaOpcion = document.createElement("option");
                    nuevaOpcion.value = implemento.id;
                    nuevaOpcion.text = implemento.nombre;
                    select.add(nuevaOpcion);
                }
            })
            .catch(function (error) {
                console.error("¡Error!", error);
            })
    }

    function traerInformacion() {
        return new Promise((resolve, reject) => {
            const id_implemento = sessionStorage.getItem('id_implemento');
            const url = 'http://localhost:3000/api/inventario/implemento/' + id_implemento;
            fetch(url, {
                method: 'GET',
            })
                .then(res => res.json())
                .then(implemento => {
                    resolve(implemento);
                })
                .catch(function (error) {
                    console.error("¡Error!", error);
                    reject(error);
                }
                );
        })

    }


    function activarEstado() {
        const url = 'http://localhost:3000/api/inventario/departamento';
        fetch(url, {
            method: 'GET',
        })
            .then(res => res.json())
            .then(implemento => {
                for (let estado of implemento) {

                }
            })
            .catch(function (error) {
                console.error("¡Error!", error);
            }
            );
    }
</script>

</html>